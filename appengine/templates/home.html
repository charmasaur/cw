<!DOCTYPE html>
<html>
  <!-- Convert a UNIX timestamp to a string (surely a library can do this...) -->
  <script type="text/javascript">
    function pad_int(x) {
      return x < 10 ? "0" + x : x;
    }
    function to_local_time_string(stamp_seconds_string) {
      date = new Date(parseInt(stamp_seconds_string * 1000));
      D = date.getDate();
      M = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov",
          "Dev"][date.getMonth()];
      Y = date.getFullYear();
      h = pad_int(date.getHours());
      m = pad_int(date.getMinutes());
      s = pad_int(date.getSeconds());
      return M + " " + D + ", " + h + ":" + m + ":" + s + " (" + Y + ")";
    }
  </script>
  <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
  <script type="text/javascript" src="/js/init_firebase.js"></script>
  <script>
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // Hide the login button.
        // TODO: Replace with a log out button.
        document.getElementById("logged_in").style.display = 'block';
        document.getElementById("logged_in_name").innerHTML = user.displayName;
        console.log("uid: " + user.uid);
        // Get the ID token, and send it to the server to update what we show. Should we show a
        // spinner or something?
        user.getIdToken().then(function(idToken) {
          console.log("ID token: " + idToken);
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState != 4) {
              return;
            }
            if (this.status == 200) {
              console.log(xhttp.responseText);
              return;
            }
            console.log("Failed: " + this.status);
          };
          xhttp.open("GET", "/get_uid", true);
          xhttp.setRequestHeader('Authorization', 'Bearer ' + idToken);
          xhttp.send();
        });
        console.log(user);
      } else {
        document.getElementById("logged_in").style.display = 'none';
      }
    });
  </script>
  <script>
    loadCrossword = function(url) {
      var xhttp = new XMLHttpRequest();
      xhttp.open("GET", url, true);
      xhttp.send();
    }
  </script>
  <body>
    <div>
      Welcome to cw-mungo!
    </div>
    <br>
    <div>
      Recently uploaded:
      <br>
      {% for recent in recents %}
      <a id="{{recent['date']}}" href="javascript:loadCrossword('{{recent['url']}}')"></a>
      <script type="text/javascript">
        stamp_string = "{{recent['date']}}";
        document.getElementById(stamp_string).innerHTML = to_local_time_string(stamp_string);
      </script>
      <br>
      {% endfor %}
      <br>
      <form action=preview method=post enctype=multipart/form-data>
        <input type="file" name="image_file"/><br>
        <input type="submit" value="Preview"/>
      </form>
      <br>
      <form action=login method=get >
        <input type="submit" value="Log in (new!!!)"/>
      </form>
      <br>
      <div id="logged_in" style="display: none;">
        You are logged in as <b><span id="logged_in_name"></span></b>
        <br><br>
      </div>
    </div>
  </body>
</html>
